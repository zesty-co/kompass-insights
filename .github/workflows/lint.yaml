name: helm-lint

on:
  push:
  pull_request:

jobs:
  lint:
    name: Helm Lint
    runs-on: ubuntu-latest

    steps:
      - name: checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: setup helm
        uses: azure/setup-helm@v4

      - name: validate Chart.yaml version changed in PR
        if: github.event_name == 'pull_request'
        run: |
          set -e

          CHART_PATH="charts/zesty"

          git fetch origin main
          MAIN_VERSION=$(git show origin/main:$CHART_PATH/Chart.yaml | yq '.version')
          PR_VERSION=$(yq '.version' $CHART_PATH/Chart.yaml)

          echo "Main version: $MAIN_VERSION"
          echo "PR version:   $PR_VERSION"

          if [ "$MAIN_VERSION" = "$PR_VERSION" ]; then
            echo "❌ Chart version has not been updated."
            exit 1
          fi

          if [ "$(printf '%s\n' "$PR_VERSION" "$MAIN_VERSION" | sort -V | head -n1)" = "$PR_VERSION" ]; then
            echo "❌ Chart version ($PR_VERSION) must be greater than main ($MAIN_VERSION)."
            exit 1
          fi

          echo "✅ Chart version bump detected."

      - name: setup kubeconform
        run: |
          go install github.com/yannh/kubeconform/cmd/kubeconform@v0.7.0
      
      - name: run all checks
        run: |
          make all

      - name: check for changes
        run: |
            git diff --exit-code || (echo "There are changes in the repository. Please commit them." && exit 1)
            echo "No changes detected."
